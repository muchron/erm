<form action="" id="formSkriningTb">
    <label for="" class="form-label">Gejala dan Tanda-tanda TB</label>
    <div class="row gy-2">
        <div class="col-lg-6">
            <label for="" class="form-label">Batuk berdahak</label>
        </div>
        <div class="col-lg-6">
            <div class="form-check form-check-inline">
                <input class="form-check-input" type="radio" name="berdahak" id="berdahak1" value="Ya">
                <label class="form-check-label" for="berdahak1">Ya</label>
            </div>
            <div class="form-check form-check-inline">
                <input class="form-check-input" type="radio" name="berdahak" id="berdahak2" value="Tidak">
                <label class="form-check-label" for="berdahak2">Tidak</label>
            </div>
        </div>


        <div class="col-lg-6"><label for="" class="form-label">Batuk berdahak lebih dari 2 minggu</label></div>
        <div class="col-lg-6">
            <div class="form-check form-check-inline">
                <input class="form-check-input" type="radio" name="berdahakB" id="berdahakB1" value="Ya">
                <label class="form-check-label" for="berdahakB1">Ya</label>
            </div>
            <div class="form-check form-check-inline">
                <input class="form-check-input" type="radio" name="berdahakB" id="berdahakB2" value="Tidak">
                <label class="form-check-label" for="berdahakB2">Tidak</label>
            </div>
        </div>

        <div class="col-lg-6"><label for="" class="form-label">Demam hilang timbul lebih dari 1 Bulan </label></div>
        <div class="col-lg-6">
            <div class="form-check form-check-inline">
                <input class="form-check-input" type="radio" name="demam" id="demam1" value="Ya">
                <label class="form-check-label" for="demam1">Ya</label>
            </div>
            <div class="form-check form-check-inline">
                <input class="form-check-input" type="radio" name="demam" id="demam2" value="Tidak">
                <label class="form-check-label" for="demam2">Tidak</label>
            </div>
        </div>

        <div class="col-lg-6"><label for="" class="form-label">Keringat malam tanpa aktivitas</label></div>
        <div class="col-lg-6">
            <div class="form-check form-check-inline">
                <input class="form-check-input" type="radio" name="keringat" id="keringat1" value="Ya">
                <label class="form-check-label" for="keringat1">Ya</label>
            </div>
            <div class="form-check form-check-inline">
                <input class="form-check-input" type="radio" name="keringat" id="keringat2" value="Tidak">
                <label class="form-check-label" for="keringat2">Tidak</label>
            </div>
        </div>

        <div class="col-lg-6"><label for="" class="form-label">Penurunan berat badan tanpa sebab yang jelas</label></div>
        <div class="col-lg-6">
            <div class="form-check form-check-inline">
                <input class="form-check-input" type="radio" name="berat" id="berat1" value="Ya">
                <label class="form-check-label" for="berat1">Ya</label>
            </div>
            <div class="form-check form-check-inline">
                <input class="form-check-input" type="radio" name="berat" id="berat2" value="Tidak">
                <label class="form-check-label" for="berat2">Tidak</label>
            </div>
        </div>

        <div class="col-lg-6"><label for="" class="form-label">Pembesaran kelenjar getah bening (benjolan di daerah leher) dengan ukuran lebih dari 2 cm</label></div>
        <div class="col-lg-6">
            <div class="form-check form-check-inline">
                <input class="form-check-input" type="radio" name="kelenjar" id="kelenjar1" value="Ya">
                <label class="form-check-label" for="kelenjar1">Ya</label>
            </div>
            <div class="form-check form-check-inline">
                <input class="form-check-input" type="radio" name="kelenjar" id="kelenjar2" value="Tidak">
                <label class="form-check-label" for="kelenjar2">Tidak</label>
            </div>
        </div>

        <div class="col-lg-6"><label for="" class="form-label">Sesak nafas dan nyeri dada</label></div>
        <div class="col-lg-6">
            <div class="form-check form-check-inline">
                <input class="form-check-input" type="radio" name="sesak" id="sesak1" value="Ya">
                <label class="form-check-label" for="sesak1">Ya</label>
            </div>
            <div class="form-check form-check-inline">
                <input class="form-check-input" type="radio" name="sesak" id="sesak2" value="Tidak">
                <label class="form-check-label" for="sesak2">Tidak</label>
            </div>
        </div>

        <div class="col-lg-6"><label for="" class="form-label">Pernah minum obat paru dalam waktu lama sebelumnya</label></div>
        <div class="col-lg-6">
            <div class="form-check form-check-inline">
                <input class="form-check-input" type="radio" name="obat" id="obat1" value="Ya">
                <label class="form-check-label" for="obat1">Ya</label>
            </div>
            <div class="form-check form-check-inline">
                <input class="form-check-input" type="radio" name="obat" id="obat2" value="Tidak">
                <label class="form-check-label" for="obat2">Tidak</label>
            </div>
        </div>

        <div class="col-lg-6"><label for="" class="form-label">Ada keluarga/tetangga yang pernah mengalami sakit paru-paru/TB/pengobatan paru-paru</label></div>
        <div class="col-lg-6">
            <div class="form-check form-check-inline">
                <input class="form-check-input" type="radio" name="keluarga" id="keluarga1" value="Ya">
                <label class="form-check-label" for="keluarga1">Ya</label>
            </div>
            <div class="form-check form-check-inline">
                <input class="form-check-input" type="radio" name="keluarga" id="keluarga2" value="Tidak">
                <label class="form-check-label" for="keluarga2">Tidak</label>
            </div>
        </div>

        <div class="col-lg-6"><label for="" class="form-label">Penyakit lain : Asma / Diabetes Melitus</label></div>
        <div class="col-lg-6">
            <div class="form-check form-check-inline">
                <input class="form-check-input" type="radio" name="penyakit" id="penyakit1" value="Ya">
                <label class="form-check-label" for="penyakit1">Ya</label>
            </div>
            <div class="form-check form-check-inline">
                <input class="form-check-input" type="radio" name="penyakit" id="penyakit2" value="Tidak">
                <label class="form-check-label" for="penyakit2">Tidak</label>
            </div>
        </div>

        <div class="col-lg-2">
            @csrf
            <button type="button" class="btn btn-primary btn-sm w-100" style="font-size: 12px" onclick="simpanSkriningTb()">
                <i class="bi bi-save">
                </i> Simpan
            </button>
        </div>
    </div>
</form>

@push('script')
    <script>
        const formSkriningTb = $('#formSkriningTb')
        const tableSkriningTbTab = document.getElementById('skriningTb-tab')
        const formSkriningTbTab = document.getElementById('formSkriningTb-tab')
        var formSkoringTb = $('#formSkoringTb');
        var formPasienSkoringTb = $('#formPasienSkoringTb');

        function simpanSkriningTb() {
            let data = {
                no_rawat: formPasienSkoringTb.find('#no_rawat').val(),
                kd_dokter: formPasienSkoringTb.find('#kd_dokter').val(),
                _token: $('#formSkriningTb').find('input[name=_token]').val(),
                id: $('#formSkriningTb').find('#id').val()

            }
            formSkriningTb.find('input[type=radio]:checked').each((item, index) => {
                data[index.name] = index.value;
            })
            $.post(`${url}/skrining/tb`,
                data
            ).done((response) => {
                alertSuccessAjax().then(() => {
                    bootstrap.Tab.getInstance(tableSkriningTbTab).show()
                    formSkriningTb.find('input[name=id]').remove();
                    formSkriningTb.trigger('reset')
                    drawTbSkriningTb(data['no_rawat'])
                });
            }).fail((request) => {
                console.log(request);
                Swal.fire({
                    title: 'Terjadi kesalahan !',
                    html: `Error Code : ${request.status}, ${request.statusText} <br/> ${request.responseJSON.map((item)=>item).join(', ')}`,
                    icon: 'error',
                    showCancelButton: false,
                })
            });

        }

        function drawTbSkriningTb(no_rawat) {
            const table = $('#tbSkriningTb').DataTable({
                scrollX: false,
                searching: false,
                paging: false,
                info: false,
                destroy: true,
                ajax: {
                    url: `${url}/skrining/tb`,
                    data: {
                        no_rawat: no_rawat,
                        dataTable: true,
                    }
                },
                columns: [{
                        data: 'id',
                        title: '',
                        render: (data, type, row, meta) => {
                            return `<button type="button" class="btn btn-sm btn-danger" onclick="hapusSkriningTb(${data})"><i class="bi bi-trash"></i></button>
                            <button type="button" class="btn btn-sm btn-warning" onclick="editSkriningTb(${data})"><i class="bi bi-pencil"></i></button>
                            <a href="{{ url('skrining/tb/print/${data}') }}" target="_blank" class="btn btn-sm btn-success" ><i class="bi bi-printer"></i></a>`;
                        }
                    },
                    {
                        data: 'tanggal',
                        title: 'Tanggal',
                        render: (data, type, row, meta) => {
                            return data;
                        }
                    },
                    {
                        data: 'pegawai.nama',
                        title: 'Petugas',
                        render: (data, type, row, meta) => {
                            return data;
                        }
                    },
                    {
                        data: '',
                        title: 'Detail',
                        render: (data, type, row, meta) => {
                            return `<ul>
                                    <li>Batuk Berdahak : [${setKeteranganSkrining(row.berdahak)}]</li>
                                    <li>Batuk berdahak lebih dari 2 minggu : [${setKeteranganSkrining(row.berdahakB)}]</li>
                                    <li>Demam hilang timbul lebih dari 1 Bulan : [${setKeteranganSkrining(row.demam)}]</li>
                                    <li>Keringat malam tanpa aktivitas : [${setKeteranganSkrining(row.keringat)}]</li>
                                    <li>Penurunan berat badan tanpa sebab yang jelas : [${setKeteranganSkrining(row.berat)}]</li>
                                    <li>Pembesaran kelenjar getah bening (benjolan di daerah leher) dengan ukuran lebih dari 2 cm : [${setKeteranganSkrining(row.kelenjar)}]</li>
                                    <li>Sesak nafas dan nyeri dada : [${setKeteranganSkrining(row.sesak)}]</li>
                                    <li>Pernah minum obat paru dalam waktu lama sebelumnya : [${setKeteranganSkrining(row.obat)}]</li>
                                    <li>Ada keluarga/tetangga yang pernah mengalami sakit paru-paru/TB/pengobatan paru-paru : [${setKeteranganSkrining(row.keluarga)}]</li>
                                    <li>Penyakit lain : Asma / Diabetes Melitus : [${setKeteranganSkrining(row.penyakit)}]</li>
                                </ul>`;
                        }
                    },
                ],
            });
        }

        function setKeteranganSkrining(data) {
            if (data !== 'Ya') {
                return `<strong class="text-success">${data}</strong>`
            } else {
                return `<strong class="text-danger">${data}</strong>`
            }
        }

        function hapusSkriningTb(id) {
            Swal.fire({
                title: 'Anda yakin ?',
                text: "Data yang dihapus tidak bisa dikembalikan",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'Yakin, hapus !',
                cancelButtonText: 'Tidak',
            }).then((result) => {
                if (result.isConfirmed) {
                    $.post(`${url}/skrining/tb/delete`, {
                        id: id,
                        _token: "{{ csrf_token() }}",
                    }).done((response) => {
                        alertSuccessAjax().then(() => {
                            drawTbSkriningTb(response.no_rawat)
                            formSkriningTb.find('#id').remove();
                        })
                    })
                }
            })

        }

        function editSkriningTb(id) {
            $.get('/erm/skrining/tb', {
                id: id,
            }).done((response) => {
                formSkriningTb.append($('<input>', {
                    type: 'hidden',
                    value: id,
                    id: 'id',
                    name: 'id',
                }));
                formSkriningTabs = new bootstrap.Tab(formSkriningTbTab);
                formSkriningTabs.show();

                formSkriningTb.find('input[type=radio]').each((item, index) => {
                    formSkriningTb.find(`input[name=${index.name}][value=${response[index.name]}]`).prop('checked', true)
                })

            })
        }


        function setNilaiSkrining(e) {
            const target = $(e).data('target')
            const val = $(e).find(':selected').val();
            const value = val === '-' ? 0 : val;

            const text = formSkoringTb.find(`input[type=text]`)
            let total = 0;
            formSkoringTb.find(`input[name=${target}]`).val(value);
            formSkoringTb.find(`input[type=text]`).each((index, element) => {
                if (element.id != 'total_skrining') {
                    total += parseInt(element.value);
                }

            });
            formSkoringTb.find('input[name=total_skrining]').val(total);
        }
    </script>
@endpush
